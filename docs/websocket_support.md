# WebSocket æ”¯æŒåŠŸèƒ½è¯´æ˜

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

åè®®æµ‹è¯•å·¥å…·ç°åœ¨æ”¯æŒ WebSocket è¿æ¥åŠŸèƒ½ï¼Œå¯ä»¥é€šè¿‡ `connect_gate` å‘½ä»¤è¿æ¥åˆ° WebSocket æœåŠ¡å™¨ã€‚

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### 1. WebSocket è¿æ¥

å½“ `host` å‚æ•°ä»¥ `ws://` æˆ– `wss://` å¼€å¤´æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«ä¸º WebSocket è¿æ¥ï¼š

```json
{
  "cmd": "connect_gate",
  "host": "wss://127.0.0.1/gateway",
  "comment": "è¿æ¥åˆ° WebSocket ç½‘å…³"
}
```

### 2. TCP è¿æ¥ï¼ˆåŸæœ‰åŠŸèƒ½ï¼‰

æ™®é€šçš„ TCP è¿æ¥æ–¹å¼ä¿æŒä¸å˜ï¼š

```json
{
  "cmd": "connect_gate",
  "host": "127.0.0.1",
  "port": 5001,
  "comment": "è¿æ¥åˆ° TCP ç½‘å…³"
}
```

### 3. è‡ªåŠ¨é€‰æ‹©è¿æ¥æ–¹å¼

`connect_gate` å‘½ä»¤ä¼šæ ¹æ® `host` å‚æ•°è‡ªåŠ¨åˆ¤æ–­è¿æ¥æ–¹å¼ï¼š

- `host` ä»¥ `ws://` æˆ– `wss://` å¼€å¤´ â†’ WebSocket è¿æ¥
- å…¶ä»–æƒ…å†µ â†’ TCP è¿æ¥

## ğŸ“‹ è¿”å›ç»“æœ

### WebSocket è¿æ¥ç»“æœ

```json
{
  "connected": true,
  "url": "wss://127.0.0.1/gateway",
  "type": "websocket"
}
```

### TCP è¿æ¥ç»“æœ

```json
{
  "connected": true,
  "host": "127.0.0.1",
  "port": 5001,
  "type": "tcp"
}
```

## ğŸ§ª æµ‹è¯•ç¤ºä¾‹

### å®Œæ•´æµ‹è¯•è„šæœ¬

```json
[
  {
    "cmd": "print",
    "message": "=== WebSocket è¿æ¥æµ‹è¯• ===",
    "comment": "å¼€å§‹æµ‹è¯•"
  },
  {
    "cmd": "connect_gate",
    "host": "wss://127.0.0.1/gateway",
    "comment": "è¿æ¥åˆ° WebSocket ç½‘å…³"
  },
  {
    "cmd": "print",
    "message": "è¿æ¥çŠ¶æ€: ret[\"connect_gate\"][\"connected\"]",
    "comment": "æ˜¾ç¤ºè¿æ¥çŠ¶æ€"
  },
  {
    "cmd": "print",
    "message": "è¿æ¥ç±»å‹: ret[\"connect_gate\"][\"type\"]",
    "comment": "æ˜¾ç¤ºè¿æ¥ç±»å‹"
  },
  {
    "cmd": "print",
    "message": "WebSocket URL: ret[\"connect_gate\"][\"url\"]",
    "comment": "æ˜¾ç¤º WebSocket URL"
  }
]
```

### æ··åˆè¿æ¥æµ‹è¯•

```json
[
  {
    "cmd": "connect_gate",
    "host": "wss://127.0.0.1/gateway",
    "comment": "WebSocket è¿æ¥"
  },
  {
    "cmd": "print",
    "message": "WebSocket è¿æ¥: ret[\"connect_gate\"][\"type\"]",
    "comment": "æ˜¾ç¤ºè¿æ¥ç±»å‹"
  },
  {
    "cmd": "connect_gate",
    "host": "127.0.0.1",
    "port": 5001,
    "comment": "TCP è¿æ¥"
  },
  {
    "cmd": "print",
    "message": "TCP è¿æ¥: ret[\"connect_gate\"][\"type\"]",
    "comment": "æ˜¾ç¤ºè¿æ¥ç±»å‹"
  }
]
```

## ğŸ› ï¸ æŠ€æœ¯å®ç°

### 1. è‡ªåŠ¨è¯†åˆ«æœºåˆ¶

```python
def execute(self, host: str = "", port: int = 0):
    # åˆ¤æ–­æ˜¯å¦ä¸º WebSocket URL
    if host.startswith(('ws://', 'wss://')):
        return self._connect_websocket(host)
    else:
        return self._connect_tcp(host, port)
```

### 2. WebSocket å®¢æˆ·ç«¯

å½“å‰å®ç°ä¸ºæ¨¡æ‹Ÿç‰ˆæœ¬ï¼Œæ”¯æŒï¼š
- âœ… è¿æ¥çŠ¶æ€æ£€æµ‹
- âœ… åŸºæœ¬çš„æ¶ˆæ¯å‘é€æ¥å£
- âœ… å¤„ç†å™¨æ³¨å†Œæ¥å£
- âœ… è¿æ¥æ–­å¼€åŠŸèƒ½

### 3. å…¼å®¹æ€§ä¿è¯

- å®Œå…¨å…¼å®¹åŸæœ‰çš„ TCP è¿æ¥åŠŸèƒ½
- ç›¸åŒçš„æ¥å£å’Œè¿”å›æ ¼å¼
- é€æ˜çš„è¿æ¥æ–¹å¼åˆ‡æ¢

## ğŸ“¦ ä¾èµ–è¦æ±‚

WebSocket åŠŸèƒ½éœ€è¦å®‰è£…é¢å¤–çš„ä¾èµ–ï¼š

```bash
pip install websockets
```

å·²æ·»åŠ åˆ° `requirements.txt`ï¼š
```
websockets==13.1
```

## ğŸ”„ å¼€å‘çŠ¶æ€

### å½“å‰çŠ¶æ€ï¼ˆv1.0ï¼‰

- âœ… åŸºæœ¬çš„ WebSocket è¿æ¥è¯†åˆ«
- âœ… æ¨¡æ‹Ÿçš„ WebSocket å®¢æˆ·ç«¯å®ç°
- âœ… ä¸ TCP è¿æ¥çš„æ— ç¼åˆ‡æ¢
- âœ… å®Œæ•´çš„æµ‹è¯•ç”¨ä¾‹

### æœªæ¥è§„åˆ’ï¼ˆv2.0ï¼‰

- ğŸ”„ çœŸå®çš„ WebSocket è¿æ¥å®ç°
- ğŸ”„ WebSocket æ¶ˆæ¯çš„æ”¶å‘åŠŸèƒ½
- ğŸ”„ WebSocket å¿ƒè·³æ£€æµ‹
- ğŸ”„ WebSocket é‡è¿æœºåˆ¶
- ğŸ”„ WebSocket å­åè®®æ”¯æŒ

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### 1. æ¸¸æˆæœåŠ¡å™¨è¿æ¥

```json
{
  "cmd": "connect_gate",
  "host": "wss://game-server.example.com/gateway",
  "comment": "è¿æ¥åˆ°æ¸¸æˆæœåŠ¡å™¨"
}
```

### 2. å¼€å‘ç¯å¢ƒæµ‹è¯•

```json
{
  "cmd": "connect_gate",
  "host": "ws://localhost:8080/websocket",
  "comment": "è¿æ¥åˆ°æœ¬åœ°å¼€å‘æœåŠ¡å™¨"
}
```

### 3. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

```json
{
  "cmd": "connect_gate",
  "host": "wss://127.0.0.1/gateway",
  "comment": "è¿æ¥åˆ°ç”Ÿäº§ç¯å¢ƒ"
}
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **å®‰å…¨æ€§**ï¼šä½¿ç”¨ `wss://` è€Œä¸æ˜¯ `ws://` ä»¥ç¡®ä¿è¿æ¥å®‰å…¨
2. **è¶…æ—¶å¤„ç†**ï¼šWebSocket è¿æ¥ä¼šæœ‰è¶…æ—¶æœºåˆ¶
3. **é”™è¯¯å¤„ç†**ï¼šè¿æ¥å¤±è´¥ä¼šè¿”å›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
4. **å…¼å®¹æ€§**ï¼šå®Œå…¨å…¼å®¹åŸæœ‰çš„ TCP è¿æ¥åŠŸèƒ½

## ğŸ”§ æ•…éšœæ’é™¤

### 1. ä¾èµ–é—®é¢˜

å¦‚æœé‡åˆ° `ModuleNotFoundError: No module named 'websockets'`ï¼š

```bash
pip install websockets
```

### 2. è¿æ¥å¤±è´¥

æ£€æŸ¥ WebSocket URL æ˜¯å¦æ­£ç¡®ï¼š
- ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„åè®® (`ws://` æˆ– `wss://`)
- ç¡®ä¿æœåŠ¡å™¨åœ°å€å’Œç«¯å£æ­£ç¡®
- æ£€æŸ¥ç½‘ç»œè¿æ¥çŠ¶æ€

### 3. åŠŸèƒ½é™åˆ¶

å½“å‰ç‰ˆæœ¬ä¸ºæ¨¡æ‹Ÿå®ç°ï¼Œå¦‚éœ€å®Œæ•´åŠŸèƒ½è¯·å…³æ³¨åç»­æ›´æ–°ã€‚

## âš ï¸ å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### SSL è¿æ¥é”™è¯¯

**é—®é¢˜**ï¼š`SSL: WRONG_VERSION_NUMBER` é”™è¯¯
**åŸå› **ï¼šä½¿ç”¨ `wss://` è¿æ¥åˆ°ä¸æ”¯æŒSSLçš„æœåŠ¡å™¨
**è§£å†³æ–¹æ¡ˆ**ï¼š
- å¯¹äºæœ¬åœ°å¼€å‘æœåŠ¡å™¨ï¼Œä½¿ç”¨ `ws://` è€Œé `wss://`
- ç¡®è®¤æœåŠ¡å™¨æ˜¯å¦æ”¯æŒSSLè¿æ¥

**ç¤ºä¾‹**ï¼š
```json
// âŒ é”™è¯¯ï¼šæœ¬åœ°æœåŠ¡å™¨é€šå¸¸ä¸æ”¯æŒSSL
{
  "cmd": "connect_gate",
  "host": "wss://127.0.0.1:5001"
}

// âœ… æ­£ç¡®ï¼šæœ¬åœ°æœåŠ¡å™¨ä½¿ç”¨éåŠ å¯†è¿æ¥
{
  "cmd": "connect_gate",
  "host": "ws://127.0.0.1:5001"
}
```

### è¿æ¥è¢«æ‹’ç»é”™è¯¯

**é—®é¢˜**ï¼š`Connection refused` é”™è¯¯
**åŸå› **ï¼šç›®æ ‡æœåŠ¡å™¨æœªè¿è¡Œæˆ–ç«¯å£ä¸æ­£ç¡®
**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç¡®è®¤æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ
- æ£€æŸ¥ç«¯å£å·æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥é˜²ç«å¢™è®¾ç½®

### ä¸»æœºåè§£æé”™è¯¯

**é—®é¢˜**ï¼š`Name or service not known` é”™è¯¯
**åŸå› **ï¼šæ— æ³•è§£æåŸŸåæˆ–IPåœ°å€
**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥URLæ‹¼å†™æ˜¯å¦æ­£ç¡®
- ç¡®è®¤ç½‘ç»œè¿æ¥æ­£å¸¸
- å¯¹äºå†…ç½‘æœåŠ¡å™¨ï¼Œç¡®è®¤DNSè®¾ç½®

## ğŸ”§ åè®®æ”¯æŒ

- **WebSocket**ï¼šåˆæ­¥æ”¯æŒï¼Œå¾…å®Œå–„
- **TCP**ï¼šå®Œå…¨æ”¯æŒ

è¿™ä¸ª WebSocket æ”¯æŒåŠŸèƒ½å¤§å¤§æ‰©å±•äº†åè®®æµ‹è¯•å·¥å…·çš„é€‚ç”¨èŒƒå›´ï¼Œä½¿å…¶èƒ½å¤Ÿæ”¯æŒç°ä»£çš„ WebSocket é€šä¿¡åè®®ï¼
